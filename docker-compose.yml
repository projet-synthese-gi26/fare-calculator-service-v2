version: "3.8"

services:
  # Service principal (Django)
  fare-calculator-service:
    image: ghcr.io/projet-synthese-gi26/fare-calculator-service:latest
    container_name: fare-calculator-service
    ports:
      - "8000:8000"
    environment:
      # Utiliser SQLite pour éviter les conflits avec la DB existante du serveur
      # Commenter POSTGRES_DB force Django à utiliser SQLite
      # - POSTGRES_DB=fare_calculator
      # - POSTGRES_USER=fox
      # - POSTGRES_PASSWORD=password123
      # - POSTGRES_HOST=database
      - REDIS_URL=redis://redis-dev:6379/1
      - DEBUG=False
      - ALLOWED_HOSTS=fare-calculator-service.pynfi.com,localhost,127.0.0.1
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/health/')"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  celery_worker:
    image: ghcr.io/projet-synthese-gi26/fare-calculator-service:latest
    command: celery -A fare_calculator worker -l info
    environment:
      - REDIS_URL=redis://redis-dev:6379/1
    depends_on:
      fare-calculator-service:
        condition: service_started
    restart: unless-stopped

  celery_beat:
    image: ghcr.io/projet-synthese-gi26/fare-calculator-service:latest
    command: celery -A fare_calculator beat -l info
    environment:
      - REDIS_URL=redis://redis-dev:6379/1
    depends_on:
      fare-calculator-service:
        condition: service_started
    restart: unless-stopped

